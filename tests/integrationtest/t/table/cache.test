# TestCacheTablePointGet
drop table if exists cache_point;
create table cache_point (id int primary key auto_increment, u int unique, v int);
insert into cache_point values(1, 11, 101);
insert into cache_point values(2, 12, 102);
alter table cache_point cache;
# check point get out transaction
select * from cache_point where id=1;
select * from cache_point where u=11;
select * from cache_point where id=2;
select * from cache_point where u=12;
select * from cache_point where u > 10 and u < 12;
# check point get in transaction
begin;
select * from cache_point where id=1;
select * from cache_point where u=11;
select * from cache_point where id=2;
select * from cache_point where u=12;
insert into cache_point values(3, 13, 103);
select * from cache_point where id=3;
select * from cache_point where u=13;
select * from cache_point where u > 12 and u < 14;
update cache_point set v=999 where id=2;
select * from cache_point where id=2;
commit;
# check point get after transaction
select * from cache_point where id=3;
select * from cache_point where u=13;
select * from cache_point where id=2;
alter table cache_point nocache;
drop table cache_point;

# TestCacheTableBatchPointGet
drop table if exists bp_cache_tmp1;
create  table bp_cache_tmp1 (id int primary key auto_increment, u int unique, v int);
insert into bp_cache_tmp1 values(1, 11, 101);
insert into bp_cache_tmp1 values(2, 12, 102);
insert into bp_cache_tmp1 values(3, 13, 103);
insert into bp_cache_tmp1 values(4, 14, 104);
alter table bp_cache_tmp1 cache;
# check point get out transaction
select * from bp_cache_tmp1 where id in (1, 3);
select * from bp_cache_tmp1 where u in (11, 13);
select * from bp_cache_tmp1 where id in (1, 3, 5);
select * from bp_cache_tmp1 where u in (11, 13, 15);
select * from bp_cache_tmp1 where u in (11, 13) and u in (12, 13);
# check point get in transaction
begin;
select * from bp_cache_tmp1 where id in (1, 3);
select * from bp_cache_tmp1 where u in (11, 13);
select * from bp_cache_tmp1 where id in (1, 3, 5);
select * from bp_cache_tmp1 where u in (11, 13, 15);
insert into bp_cache_tmp1 values(6, 16, 106);
select * from bp_cache_tmp1 where id in (1, 6);
select * from bp_cache_tmp1 where u in (11, 16);
update bp_cache_tmp1 set v=999 where id=3;
select * from bp_cache_tmp1 where id in (1, 3);
select * from bp_cache_tmp1 where u in (11, 13);
select * from bp_cache_tmp1 where u in (11, 13) and u in (12, 13);
delete from bp_cache_tmp1 where id=4;
select * from bp_cache_tmp1 where id in (1, 4);
select * from bp_cache_tmp1 where u in (11, 14);
commit;
# check point get after transaction
select * from bp_cache_tmp1 where id in (1, 3, 6);
select * from bp_cache_tmp1 where u in (11, 13, 16);
select * from bp_cache_tmp1 where id in (1, 4);
select * from bp_cache_tmp1 where u in (11, 14);
alter table bp_cache_tmp1 nocache;
drop table bp_cache_tmp1;

# TestCacheTableAddColumns
drop table if exists cache_add_column;
create table cache_add_column (f1 int, index k(f1));
insert into cache_add_column (f1) values (1);
alter table cache_add_column add column f2 int not null, add column f3 int default 3, add column f4 int default null;
alter table cache_add_column cache;
select sleep(0.1);
select * from cache_add_column;
select sleep(0.1);
select * from cache_add_column;
select sleep(0.1);
select * from cache_add_column;
select sleep(0.1);
select * from cache_add_column;
select sleep(0.1);
select * from cache_add_column;
select sleep(0.1);
select * from cache_add_column;
select sleep(0.1);
select * from cache_add_column;
select sleep(0.1);
select * from cache_add_column;
select sleep(0.1);
select * from cache_add_column;
select sleep(0.1);
select * from cache_add_column;
select sleep(0.1);
select * from cache_add_column use index(k) where f1 = 1;
select sleep(0.1);
select * from cache_add_column use index(k) where f1 = 1;
select sleep(0.1);
select * from cache_add_column use index(k) where f1 = 1;
select sleep(0.1);
select * from cache_add_column use index(k) where f1 = 1;
select sleep(0.1);
select * from cache_add_column use index(k) where f1 = 1;
select sleep(0.1);
select * from cache_add_column use index(k) where f1 = 1;
select sleep(0.1);
select * from cache_add_column use index(k) where f1 = 1;
select sleep(0.1);
select * from cache_add_column use index(k) where f1 = 1;
select sleep(0.1);
select * from cache_add_column use index(k) where f1 = 1;
select sleep(0.1);
select * from cache_add_column use index(k) where f1 = 1;
alter table cache_add_column nocache;
drop table cache_add_column;

# TestCachedTableHotRangeVariables
select @@global.tidb_enable_cached_table_hot_range_point_get;
set @@global.tidb_enable_cached_table_hot_range_point_get = 1;
select @@global.tidb_enable_cached_table_hot_range_point_get;
set @@global.tidb_enable_cached_table_hot_range_point_get = 0;
select @@global.tidb_enable_cached_table_hot_range_point_get;

select @@global.tidb_cached_table_hot_range_max_segments;
set @@global.tidb_cached_table_hot_range_max_segments = 8;
select @@global.tidb_cached_table_hot_range_max_segments;
set @@global.tidb_cached_table_hot_range_max_segments = 1000001;
show warnings;
select @@global.tidb_cached_table_hot_range_max_segments;
set @@global.tidb_cached_table_hot_range_max_segments = 0;
select @@global.tidb_cached_table_hot_range_max_segments;
set @@global.tidb_cached_table_hot_range_max_segments = 4096;

select @@global.tidb_cached_table_hot_range_admission_threshold;
set @@global.tidb_cached_table_hot_range_admission_threshold = 2;
select @@global.tidb_cached_table_hot_range_admission_threshold;
set @@global.tidb_cached_table_hot_range_admission_threshold = 0;
show warnings;
select @@global.tidb_cached_table_hot_range_admission_threshold;
set @@global.tidb_cached_table_hot_range_admission_threshold = 17;
show warnings;
select @@global.tidb_cached_table_hot_range_admission_threshold;
set @@global.tidb_cached_table_hot_range_admission_threshold = 1;

select @@global.tidb_enable_cached_table_invalidation_async_persist;
set @@global.tidb_enable_cached_table_invalidation_async_persist = 1;
select @@global.tidb_enable_cached_table_invalidation_async_persist;
set @@global.tidb_enable_cached_table_invalidation_async_persist = 0;
select @@global.tidb_enable_cached_table_invalidation_async_persist;

# TestCachedTableAsyncInvalidationLog
set @old_async_invalidation = @@global.tidb_enable_cached_table_async_invalidation;
set @old_async_persist = @@global.tidb_enable_cached_table_invalidation_async_persist;
set @@global.tidb_enable_cached_table_async_invalidation = 1;
set @@global.tidb_enable_cached_table_invalidation_async_persist = 0;

drop table if exists cache_inval_log1;
drop table if exists cache_inval_log2;
create table cache_inval_log1 (id int primary key, v int);
create table cache_inval_log2 (id int primary key, v int);
insert into cache_inval_log1 values (1, 10), (2, 20);
insert into cache_inval_log2 values (1, 100), (2, 200);
alter table cache_inval_log1 cache;
alter table cache_inval_log2 cache;

delete from mysql.table_cache_invalidation_log;
begin;
update cache_inval_log1 set v = v + 1 where id = 1;
insert into cache_inval_log1 values (3, 30);
delete from cache_inval_log1 where id = 2;
commit;
select count(*) from mysql.table_cache_invalidation_log;
select count(*) from mysql.table_cache_invalidation_log where invalidation_epoch = commit_ts and commit_ts > 0;

delete from mysql.table_cache_invalidation_log;
begin;
update cache_inval_log1 set v = v + 1 where id = 1;
update cache_inval_log2 set v = v + 1 where id = 1;
commit;
select count(*) from mysql.table_cache_invalidation_log;

alter table cache_inval_log1 nocache;
alter table cache_inval_log2 nocache;
drop table cache_inval_log1;
drop table cache_inval_log2;

set @@global.tidb_enable_cached_table_invalidation_async_persist = @old_async_persist;
set @@global.tidb_enable_cached_table_async_invalidation = @old_async_invalidation;
